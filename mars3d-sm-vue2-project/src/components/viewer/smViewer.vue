<template>
  <div id="cesiumContainer" ref="viewer" class="mars3d-container">
    <!-- 工具选择组件 -->
    <tool-bar></tool-bar>
    <compass></compass>
    <china-epidemic-map></china-epidemic-map>
    <world-epidemic-map></world-epidemic-map>
    <init-echarts></init-echarts>
    <info-manage :isCreateScene="isCreateScene"></info-manage>
  </div>
</template>

<script>
//引入portal处理公共类
import { getRootUrl } from "../../common/js/portalTools";

import BaseSpecialEffectModels from "../../data/BaseSpecialEffectsData.js";
import InitEcharts from "../combinations/initecharts/initEcharts";
import InfoManage from "../combinations/infomanage/infoManage";
export default {
  name: "sm-viewer",
  components: { InfoManage, InitEcharts },
  props: {
    combination: {
      //组合接口
      type: Boolean,
    },
    sceneUrl: {
      //场景接口
      type: String,
    },
    s3mScps: {
      //s3m图层接口
      type: Array,
    },
    collapsed: {
      //是否折叠
      type: Boolean,
    },
  },
  data() {
    return {
      sharedState: store.state,
      isCreateScene: true,
    };
  },
  computed: {
    isInitViewer: function() {
      return this.sharedState.isInitViewer;
    },
  },
  methods: {
    init() {
      //初始化viewer
      if (window.viewer) {
        return;
      }
      let map;
      let viewer;

      //天空盒，不能放在data里面
      this.BaseSpecialEffectModels = BaseSpecialEffectModels;
      this.getCreateOrEditScene();
      let isPCBroswer = (window.isPCBroswer = Cesium.FeatureDetection.isPCBroswer());
      let skyBoxRight = this.BaseSpecialEffectModels[1].skyBoxRight;
      let skyBoxLeft = this.BaseSpecialEffectModels[1].skyBoxLeft;
      let skyBoxFront = this.BaseSpecialEffectModels[1].skyBoxFront;
      let skyBoxBack = this.BaseSpecialEffectModels[1].skyBoxBack;
      let skyBoxUp = this.BaseSpecialEffectModels[1].skyBoxUp;
      let skyBoxDown = this.BaseSpecialEffectModels[1].skyBoxDown;
      if (isPCBroswer) {
        map = new mars3d.Map("cesiumContainer", {
          scene: {
            contextOptions: {
              requestWebgl2: window.device == "iOS" ? false : true,
            },
          },
          control: {
            defaultContextMenu: true,
            locationBar: {
              fps: false,
              crs: "CGCS2000_GK_Zone_3",
              crsDecimal: 0,
              template:
                "<div>经度:{lng}</div> <div>纬度:{lat}</div> <div>横{crsx}  纵{crsy}</div> <div>海拔：{alt}米</div> <div>层级：{level}</div><div>方向：{heading}°</div> <div>俯仰角：{pitch}°</div><div>视高：{cameraHeight}米</div>",
            },
          },
          basemaps: [
            {
              name: "天地图影像",
              icon: "img/basemaps/tdt_img.png",
              type: "group",
              layers: [
                {
                  name: "底图",
                  type: "tdt",
                  layer: "img_d",
                  key: ["9ae78c51a0a28f06444d541148496e36"],
                },
                {
                  name: "注记",
                  type: "tdt",
                  layer: "img_z",
                  key: ["9ae78c51a0a28f06444d541148496e36"],
                },
              ],
              show: true,
            },
          ],
        });
        viewer = map.viewer;

        // viewer.scene.moon.show = false;
        // document.getElementsByClassName(
        //   "cesium-viewer-timelineContainer"
        // )[0].style.visibility = "hidden"; //隐藏时间线控件

        // viewer.scene.globe.enableLighting = false;

        let wxSkyBox = new Cesium.SkyBox({
          sources: {
            positiveX: skyBoxRight,
            negativeX: skyBoxLeft,
            positiveY: skyBoxFront,
            negativeY: skyBoxBack,
            positiveZ: skyBoxUp,
            negativeZ: skyBoxDown,
          },
        });
        let initialSkyBox = function() {
          if (viewer.scene.frameState.passes.render) {
            wxSkyBox.update(viewer.scene.frameState, true);
            viewer.scene.postRender.removeEventListener(initialSkyBox);
          }
        };
        viewer.scene.postRender.addEventListener(initialSkyBox);
        this.BaseSpecialEffectModels[1].currentSky = wxSkyBox;
        this.BaseSpecialEffectModels[1].defaultSky = viewer.scene.skyBox;
      } else {
        map = new mars3d.Map("cesiumContainer", {
          scene: {
            contextOptions: {
              requestWebgl2: window.device == "iOS" ? false : true,
            },
          },
        });
        viewer = map.viewer;

        let scene = viewer.scene;
        if (Cesium.defined(scene.sun)) {
          scene.globe.enableLighting = false;
        }
        if (Cesium.defined(scene.moon)) {
          scene.moon.show = false;
        }
        document.documentElement.style.height = window.innerHeight + "px";
        document.addEventListener(
          "touchmove",
          function(e) {
            e.preventDefault();
          },
          false
        );
        store.setCompass(false); //关闭罗盘等
      }

      window.map = map;
      window.viewer = viewer;
      window.scene = viewer.scene;

      let widget = viewer.cesiumWidget;
      // iEarth进行初始化设置
      viewer.scene.globe.depthTestAgainstTerrain = true;
      viewer.scene.globe.baseColor = Cesium.Color.BLACK; // 没有影像图层时地球的底色
      if (viewer.geocoder) {
        // 请开发者自行到supermap online官网（http://www.supermapol.com/）申请key
        viewer.geocoder.viewModel.geoKey = "fvV2osxwuZWlY0wJb8FEb2i5";
        document.querySelector(".cesium-geocoder-input").placeholder =
          Resource.searchPlaceHolder;
      }
      viewer.camera.flyTo({
        // destination: new Cesium.Cartesian3(
        //   6788287.844465209,
        //   -41980756.10214644,
        //   29619220.04004376
        // ),
        destination: new Cesium.Cartesian3.fromDegrees(
          110.60396458865515,
          34.54408834959379,
          30644793.325518917
        ),
        duration: 0,
        complete: function() {
          common.initHandler("Polygon"); //初始化全局常用的画面的drawhandler
          store.setToolBarShow(true); //显示工具栏

          // viewer.camera.flyTo({
          //   destination: new Cesium.Cartesian3.fromDegrees(
          //     110.60396458865515,
          //     34.54408834959379,
          //     30644793.325518917
          //   ),
          //   duration: 2,
          //   complete: function() {
          //     common.initHandler("Polygon"); //初始化全局常用的画面的drawhandler
          //     store.setToolBarShow(true); //显示工具栏
          //   }
          // });
          setTimeout(() => {
            document.getElementById("loadingbar").remove(); //移除加载动画
          }, 1000);
        },
      });

      store.setisInitViewer(true); //初始化viewer标志

      //对接iport代码,登录功能
      let that = this;
      if (window.store.systemConfig) {
        that.getSceneState("block");
      } else {
        // earth
        that.getSceneState("none");
      }
    },

    getSceneState(state) {
      document.getElementById("infoManageLogin").style.display = state;
      document.getElementById("storageInfo").style.display = state;

      //未登录
      let userInfo = window.store.portalUserprofile;
      if (!userInfo || userInfo.userName === "GUEST") {
        document.getElementById("storageInfo").style.display = "none";
      }
      //无权限
      if (window.store.portalUserprofile) {
        let iportalUpdateScene =
          window.store.portalUserprofile.modulePermissions;
        if (
          !iportalUpdateScene.includes(
            "portal:user:createUpdateDeleteScenes"
          ) &&
          !iportalUpdateScene.includes("*")
        ) {
          document.getElementById("storageInfo").style.display = "none";
        }
      }
    },
    getCreateOrEditScene() {
      //判断编辑场景还是创建场景
      let url = window.location.href;
      this.isCreateScene = url.indexOf("id=") === -1;
      // 模拟编辑场景模式，非创建
      // this.isCreateScene = false;
    },
  },
  mounted() {
    this.init();
    if (window.location.search === "?theme=wind") {
      store.setSpecialEffects(4, 1);
    }
  },
};
</script>
<style lang="scss" scoped>
/*超图版本多加的css*/
.cesium-viewer-navigationContainer {
  top: 0px;
  right: 0px;
  left: auto;
  z-index: 99;
}

.cesium-viewer-toolbar {
  z-index: 999;
}
</style>
